# Data & Storage Layout

This document captures the current database model and filesystem layout so we can migrate data safely while upgrading to PHP 8.3+/Symfony 7.x.

---

## 1. Database Snapshot Plan

1. **Configure connection** – set real credentials in `app/config/parameters.yml` and ensure the legacy app can reach the database (MySQL assumed from `pdo_mysql`).
2. **Introspect mappings**  
   ```bash
   php app/console doctrine:mapping:info
   php app/console doctrine:schema:update --dump-sql
   php app/console doctrine:schema:validate
   ```
   These commands list all mapped entities/tables and highlight schema drift before exporting.
3. **Export schema & data** – use `mysqldump --routines --add-drop-table <db>` (or `mysqldump --no-data` for schema-only snapshots). Keep anonymised fixtures for tests plus a full production dump for migration rehearsals.
4. **Track migrations** – once the project moves to Symfony Flex/Doctrine Migrations, replay the legacy schema via an initial baseline migration generated from the dump above.

---

## 2. Entity / Table Inventory

> Table names follow Doctrine defaults unless a custom name is declared. Join tables for many-to-many relations use Doctrine’s autogenerated names (e.g. `page_category`, `resymf_users_roles`).

### CMS Bundle (`ReSymf\Bundle\CmsBundle`)

| Table | Key Columns | Relations | Notes |
| --- | --- | --- | --- |
| `resymf_users` (`User`) | `id`, `username`, `salt`, `password`, `email`, `is_active`, `theme_id` | Many-to-many `roles`, many-to-one `theme` | Implements `AdvancedUserInterface`; slugs/auto inputs for profile editing. |
| `resymf_roles` (`Role`) | `id`, `name`, `role` (unique) | Many-to-many with `resymf_users` | Used by console commands `security:createadmin` & `security:createrole`. |
| `page` (`Page`) | `id`, `title`, `content`, `slug`, `create_date`, `author_id` | Many-to-many `categories`, many-to-one `author` (`User`) | Extends `BasePage`; categories join table auto-managed. |
| `category` (`Category`) | `id`, `name`, `content` | Many-to-many with `page` | Simple label/description store. |
| `theme` (`Theme`) | `id`, `name` | One-to-many `users` | Hidden admin entry; associates UI theme with users. |
| `settings` (`Settings`) | `id`, `app_name`, `seo_description`, `seo_keywords`, `seo_separator`, `ga_key` | – | Admin “Settings” screen always edits the first row. |
| `resymf_users_roles` | `user_id`, `role_id` | Join table for `User` ↔ `Role` | Doctrine-generated. |

### Project Manager Bundle (`ReSymf\Bundle\ProjectManagerBundle`)

| Table | Key Columns | Relations | Notes |
| --- | --- | --- | --- |
| `project` (`Project`) | `id`, `name`, `start_date`, `end_date`, `hour_price`, cached totals, `description`, `data_access` | One-to-many `sprints`, `documents`, `terms`; many-to-many `contacts` | Aggregates Sprint/Task hierarchy plus contact associations. |
| `sprint` (`Sprint`) | core scheduling fields | Many-to-one `project`; one-to-many `tasks` | Hidden admin menu entry. |
| `task` (`Task`) | `id`, `name`, `description`, `total_hours`, `real_total_hours`, `priority`, `status` | Many-to-one `sprint`; many-to-many `documents`; one-to-many `issues` | Annotation-driven relations for admin forms. |
| `issue` (`Issue`) | `id`, `name`, `description`, `status`, etc. | Many-to-one `task` | Tracks blockers/bugs for tasks. |
| `contact` (`Contact`) | `id`, `name`, `email`, phones, address, notes | Many-to-one `project`, many-to-one `company` | Provides lightweight CRM; exposed in admin menu. |
| `company` (`Company`) | `id`, `name`, `zip`, `street`, `nip` | One-to-many `contacts` | No direct admin menu entry but referenced by contacts. |
| `document` (`Document`) | `id`, `name`, `path` (array), `project_id` | Many-to-one `project`; many-to-many with `task` | Stores uploaded files (JSON/array of filenames). |
| `term` (`Term`) | `id`, `name`, `create_date`, `description`, `project_id` | Many-to-one `project` | Represents payment terms/milestones. |

### Other Structures

- **Annotation metadata**: Custom `@Form` and `@Table` annotations (see `src/ReSymf/Bundle/CmsBundle/Annotation`) add UI metadata (labels, auto-input configs, relation hints) rather than database columns, but they drive runtime features such as slug generation and default values.
- **Repositories**: `SettingsRepository` implements helper queries; other entities rely on default repositories.

---

## 3. File & Upload Layout

| Path | Purpose | Notes |
| --- | --- | --- |
| `web/uploads/` | Global upload bucket used by admin forms and `FileManagerController::uploadAction` | Files are saved using sanitized original names with random prefixes to avoid collisions. Sample assets (icons, PDFs, AVIs) already live here—clean before production deployments. |
| `web/uploads/documents/` | Document-specific storage used by `Document::getUploadDir()` | `Document.path` column stores an `array` of filenames relative to this directory. |
| `web/tempname.pdf`, `web/*.png` | Legacy static assets served directly from the old `web/` root | Will need migration into the new `public/` tree or asset pipeline. |
| `components/` | Third-party JS/CSS (jQuery, RequireJS bundles) | Replaced once Webpack Encore/Vite is introduced. |

**Upload flow**: `/admin/upload-file` (POST) → `FileManagerController::uploadAction` moves the file into `web/uploads/`, emits a JSON payload (`{status, fileName}`), and relies on the Referer header for client-side routing. No ACL/virus scanning/versioning exists.

---

## 4. Migration Considerations

1. **Normalize filenames** – add database columns or a media table to track uploads explicitly; migrate JSON arrays in `Document.path` to a structured model.
2. **Relocate storage** – move `web/uploads` to `public/uploads` (or outside web root + signed URLs) and use Symfony Filesystem/Flysystem for portability.
3. **Enforce constraints** – add DB-level unique indexes where business logic already enforces uniqueness (e.g., `User.username`, `Page.slug`).
4. **Seed data** – convert console commands (`security:createadmin`, `resymf:populate`) into Doctrine fixtures/migrations compatible with Symfony 7.

Keep this document updated whenever schema changes or new storage locations are introduced during the upgrade.
