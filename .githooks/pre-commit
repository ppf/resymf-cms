#!/bin/bash

# Pre-Commit Hook for Code Quality
# Copy this file to .git/hooks/pre-commit and make it executable:
# cp .githooks/pre-commit .git/hooks/pre-commit
# chmod +x .git/hooks/pre-commit

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BLUE}   Running Pre-Commit Quality Checks${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

# Get list of staged PHP files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep ".php$")

if [ -z "$STAGED_FILES" ]; then
    echo -e "${YELLOW}No PHP files to check${NC}"
    exit 0
fi

echo -e "${BLUE}Files to check:${NC}"
echo "$STAGED_FILES"
echo ""

# Check 1: PHP Syntax Check
echo -e "${BLUE}[1/4] PHP Syntax Check...${NC}"
SYNTAX_ERROR=0
for FILE in $STAGED_FILES; do
    php -l "$FILE" > /dev/null 2>&1
    if [ $? -ne 0 ]; then
        echo -e "${RED}✗ Syntax error in: $FILE${NC}"
        php -l "$FILE"
        SYNTAX_ERROR=1
    fi
done

if [ $SYNTAX_ERROR -eq 1 ]; then
    echo -e "${RED}✗ Syntax check failed${NC}"
    exit 1
fi
echo -e "${GREEN}✓ Syntax check passed${NC}"
echo ""

# Check 2: PHP-CS-Fixer
echo -e "${BLUE}[2/4] Code Style Check (PHP-CS-Fixer)...${NC}"
if [ -f "vendor/bin/php-cs-fixer" ]; then
    vendor/bin/php-cs-fixer fix --dry-run --diff --verbose $(echo "$STAGED_FILES" | tr '\n' ' ')
    if [ $? -ne 0 ]; then
        echo -e "${YELLOW}⚠ Code style issues found${NC}"
        echo -e "${YELLOW}Run 'make cs-fix' or 'vendor/bin/php-cs-fixer fix' to auto-fix${NC}"

        # Ask if user wants to auto-fix
        read -p "Auto-fix code style issues? (y/n) " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            vendor/bin/php-cs-fixer fix $(echo "$STAGED_FILES" | tr '\n' ' ')
            # Re-stage fixed files
            git add $STAGED_FILES
            echo -e "${GREEN}✓ Code style fixed and files re-staged${NC}"
        else
            echo -e "${RED}✗ Code style check failed${NC}"
            exit 1
        fi
    else
        echo -e "${GREEN}✓ Code style check passed${NC}"
    fi
else
    echo -e "${YELLOW}⚠ PHP-CS-Fixer not installed (skipping)${NC}"
fi
echo ""

# Check 3: PHPStan (only on changed files)
echo -e "${BLUE}[3/4] Static Analysis (PHPStan)...${NC}"
if [ -f "vendor/bin/phpstan" ]; then
    # Create temporary list of files to analyze
    TEMP_FILE=$(mktemp)
    echo "$STAGED_FILES" | tr ' ' '\n' > "$TEMP_FILE"

    vendor/bin/phpstan analyse --no-progress --error-format=table $(cat "$TEMP_FILE")
    PHPSTAN_EXIT=$?
    rm "$TEMP_FILE"

    if [ $PHPSTAN_EXIT -ne 0 ]; then
        echo -e "${RED}✗ PHPStan found issues${NC}"
        echo -e "${YELLOW}Fix issues or use 'git commit --no-verify' to skip${NC}"
        exit 1
    else
        echo -e "${GREEN}✓ Static analysis passed${NC}"
    fi
else
    echo -e "${YELLOW}⚠ PHPStan not installed (skipping)${NC}"
fi
echo ""

# Check 4: Run Tests (optional, can be slow)
# Uncomment to enable test running on commit
# echo -e "${BLUE}[4/4] Running Tests...${NC}"
# if [ -f "vendor/bin/phpunit" ]; then
#     vendor/bin/phpunit --testsuite unit
#     if [ $? -ne 0 ]; then
#         echo -e "${RED}✗ Tests failed${NC}"
#         exit 1
#     fi
#     echo -e "${GREEN}✓ Tests passed${NC}"
# else
#     echo -e "${YELLOW}⚠ PHPUnit not installed (skipping)${NC}"
# fi
# echo ""

echo ""
echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${GREEN}   ✓ All Pre-Commit Checks Passed!${NC}"
echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

exit 0
