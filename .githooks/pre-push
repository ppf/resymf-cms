#!/bin/bash

# Pre-Push Hook for Full CI Simulation
# Copy this file to .git/hooks/pre-push and make it executable:
# cp .githooks/pre-push .git/hooks/pre-push
# chmod +x .git/hooks/pre-push

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BLUE}   Running Pre-Push CI Simulation${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

FAILED=0

# Check 1: Composer Validation
echo -e "${BLUE}[1/6] Validating composer.json...${NC}"
composer validate --strict
if [ $? -ne 0 ]; then
    echo -e "${RED}✗ Composer validation failed${NC}"
    FAILED=1
else
    echo -e "${GREEN}✓ Composer validation passed${NC}"
fi
echo ""

# Check 2: PHPStan
echo -e "${BLUE}[2/6] Running PHPStan (Level 5)...${NC}"
if [ -f "vendor/bin/phpstan" ]; then
    vendor/bin/phpstan analyse --memory-limit=1G --no-progress
    if [ $? -ne 0 ]; then
        echo -e "${RED}✗ PHPStan analysis failed${NC}"
        FAILED=1
    else
        echo -e "${GREEN}✓ PHPStan analysis passed${NC}"
    fi
else
    echo -e "${YELLOW}⚠ PHPStan not installed (install with: make install-dev)${NC}"
fi
echo ""

# Check 3: Code Style
echo -e "${BLUE}[3/6] Checking code style...${NC}"
if [ -f "vendor/bin/php-cs-fixer" ]; then
    vendor/bin/php-cs-fixer fix --dry-run --diff --verbose
    if [ $? -ne 0 ]; then
        echo -e "${RED}✗ Code style check failed${NC}"
        echo -e "${YELLOW}Run 'make cs-fix' to auto-fix${NC}"
        FAILED=1
    else
        echo -e "${GREEN}✓ Code style check passed${NC}"
    fi
else
    echo -e "${YELLOW}⚠ PHP-CS-Fixer not installed (install with: make install-dev)${NC}"
fi
echo ""

# Check 4: Tests
echo -e "${BLUE}[4/6] Running PHPUnit tests...${NC}"
if [ -f "vendor/bin/phpunit" ] || [ -f "bin/phpunit" ]; then
    if [ -f "bin/phpunit" ]; then
        bin/phpunit -c app --no-coverage
    else
        vendor/bin/phpunit -c app --no-coverage
    fi

    if [ $? -ne 0 ]; then
        echo -e "${RED}✗ Tests failed${NC}"
        FAILED=1
    else
        echo -e "${GREEN}✓ Tests passed${NC}"
    fi
else
    echo -e "${YELLOW}⚠ PHPUnit not installed${NC}"
fi
echo ""

# Check 5: Security Audit
echo -e "${BLUE}[5/6] Running security audit...${NC}"
composer audit
if [ $? -ne 0 ]; then
    echo -e "${YELLOW}⚠ Security vulnerabilities found${NC}"
    echo -e "${YELLOW}Review and fix before production deployment${NC}"
    # Don't fail on security issues, just warn
else
    echo -e "${GREEN}✓ Security audit passed${NC}"
fi
echo ""

# Check 6: Check for Debug Code
echo -e "${BLUE}[6/6] Checking for debug code...${NC}"
DEBUG_FOUND=0

# Check for var_dump, dump, dd, print_r in non-test files
if git grep -n "var_dump\|dump(\|dd(\|print_r" -- "src/*.php" ":(exclude)src/*/Tests/*" > /dev/null 2>&1; then
    echo -e "${YELLOW}⚠ Warning: Debug statements found:${NC}"
    git grep -n "var_dump\|dump(\|dd(\|print_r" -- "src/*.php" ":(exclude)src/*/Tests/*"
    DEBUG_FOUND=1
fi

# Check for die() or exit() in non-test files
if git grep -n "\(die\|exit\)(" -- "src/*.php" ":(exclude)src/*/Tests/*" > /dev/null 2>&1; then
    echo -e "${YELLOW}⚠ Warning: die/exit statements found:${NC}"
    git grep -n "\(die\|exit\)(" -- "src/*.php" ":(exclude)src/*/Tests/*"
    DEBUG_FOUND=1
fi

if [ $DEBUG_FOUND -eq 1 ]; then
    echo -e "${YELLOW}⚠ Consider removing debug code before pushing${NC}"
    read -p "Continue anyway? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        FAILED=1
    fi
else
    echo -e "${GREEN}✓ No debug code found${NC}"
fi
echo ""

# Final result
echo ""
if [ $FAILED -eq 1 ]; then
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${RED}   ✗ CI Simulation Failed${NC}"
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo -e "${YELLOW}Fix the issues above or use 'git push --no-verify' to skip${NC}"
    echo ""
    exit 1
else
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${GREEN}   ✓ All CI Checks Passed!${NC}"
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    exit 0
fi
